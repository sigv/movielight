/* eslint-env browser, jquery */
$(function(){"use strict";var e={},i={};$.fn.api.settings.api={search:"/m/search/{query}"},$(".ui.modal").modal({blurring:!0,onHide:function(t){i={},history.pushState({},"","/#/m"+(e.id||"")+"/p"+(i.id||"")),document.title=(e.title?e.title+" • ":"")+"Movie Light"}});var t=function(t){e={id:t},t&&$.ajax("/m/"+t,{dataType:"json",success:function(t){if(t&&t.movie&&t.movie.id===e.id){history.pushState({},"","/#/m"+(e.id||"")+"/p"+(i.id||"")),e=t.movie,document.title=(i.name?i.name:t.movie.title)+" • Movie Light",$(".poster").attr("src",t.movie.posterUrl||""),$(".title").text(t.movie.originalTitle+(t.movie.year?" ("+t.movie.year+")":"")),$(".subtitle").text(t.movie.title!==t.movie.originalTitle?t.movie.title:""),$(".synopsis").text(t.movie.description||""),$(".actors").empty();for(var o=function(e){n($(e.currentTarget).data("id"))},s=0;s<t.movie.cast.length;s++){var r=t.movie.cast[s],a=$('<div class="clickable two wide column"><img class="ui fluid circular image"><br><p><b class="name"></b><br><em class="role"></em></p></div>');a.data("id",r.id),a.find(".image").attr("src",r.imageUrl),a.find(".name").text(r.name),a.find(".role").text(r.role),a.click(o),$(".actors").append(a)}}}})},n=function(n){i={id:n},n&&$.ajax("/p/"+n,{dataType:"json",success:function(n){if(n&&n.person&&n.person.id===i.id){history.pushState({},"","/#/m"+(e.id||"")+"/p"+(i.id||"")),i=n.person,document.title=n.person.name+" • Movie Light";var o=$(".ui.modal");o.find(".header .name").text(n.person.name),o.find(".header .subname").text([n.person.age?"1"===n.person.age?"1 year old":n.person.age+" years old":"",n.person.alsoKnownAs&&n.person.alsoKnownAs.length>0?"also known as "+n.person.alsoKnownAs.join(", "):""].filter(function(e){return"string"==typeof e&&""!==e}).join(" • ")),o.find(".profile").attr("src",n.person.imageUrl),o.find(".bio").text(n.person.bio||""),o.find(".movies").empty();for(var s=function(e){i={},t($(e.currentTarget).data("id")),setTimeout(function(){o.modal("hide")},1)},r=0;r<n.person.movies.length;r++){var a=n.person.movies[r],l=$('<div class="clickable four wide movie column"><img class="ui fluid rounded image"><br><p><b class="title"></b><br><em class="year"></em></p></div>');l.data("id",a.id),l.find(".image").attr("src",a.posterUrl),l.find(".title").text(a.title),l.find(".year").text(a.year),l.click(s),o.find(".movies").prepend(l)}setTimeout(function(){o.modal("show")},1)}}})};window.onhashchange=function(){var o=location.hash.match(/^#\/m([0-9]*)\/p([0-9]*)$/),s=o?parseInt(o[1],10)||null:null;(null!==s?s!==e.id:void 0!==e.id&&null!==e.id)&&t(s);var r=o?parseInt(o[2],10)||null:null;(null!==r?r!==i.id:void 0!==i.id&&null!==i.id)&&n(r)},window.onhashchange(),$(".ui.search").search({apiSettings:{onResponse:function(e){for(var i=0;i<e.movies.length;i++)for(var t in e.movies[i])e.movies[i].hasOwnProperty(t)&&!e.movies[i][t]&&delete e.movies[i][t];return e}},transition:"swing down",duration:300,cache:!1,fields:{results:"movies",description:"year",image:"posterUrl"},onSelect:function(e,i){return $(".poster").attr("src",e.posterUrl||""),$(".title").text(e.originalTitle+(e.year?" ("+e.year+")":"")),$(".subtitle").text(e.title!==e.originalTitle?e.title:""),$(".synopsis").text(e.description||""),t(e.id),!0},onResultsOpen:function(){$(".bodycontainer").dimmer("show")},onResultsClose:function(){$(".bodycontainer").dimmer("hide")}})});